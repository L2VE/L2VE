#version: "3.8"

# ==========================================
# L2VE 통합 Docker Compose 설정 (최종본)
# ==========================================
# 서비스: Frontend + Backend + PostgreSQL + Jenkins
#
# 기존 설정 반영:
# - PostgreSQL: pgvector/pgvector:pg16, postdb, admin/password
# - Jenkins: jenkins/jenkins:lts, Docker 소켓 연결
#
# 실행:
#   docker-compose up -d
#   또는
#   make up
# ==========================================

services:
  # ==========================================
  # PostgreSQL (pgvector 지원)
  # ==========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: l2ve-postgres
    user: root
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-postdb}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
      TZ: Asia/Seoul

    ports:
      - "${POSTGRES_EXTERNAL_PORT:-5433}:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./data/postgres-backups:/backups
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro

    networks:
      - l2ve-network

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-postdb}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================
  # Jenkins CI/CD
  # ==========================================
  jenkins:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    container_name: l2ve-jenkins
    user: root
    restart: unless-stopped

    environment:
      # Jenkins Admin 계정
      JENKINS_ADMIN_USER: ${JENKINS_ADMIN_USER:-admin}
      JENKINS_ADMIN_PASSWORD: ${JENKINS_ADMIN_PASSWORD:-admin}

      # Jenkins URL (내부: http://jenkins:8080, 외부: http://localhost:10218)
      JENKINS_URL: ${JENKINS_URL:-http://jenkins:8080}

      # Credentials
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY:-}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-https://api.langfuse.com}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK:-}
      BEDROCK_AWS_REGION: ${BEDROCK_AWS_REGION:-ap-southeast-2}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-25}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_USE_SSL: ${SMTP_USE_SSL:-false}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-false}
      SMTP_REPLY_TO: ${SMTP_REPLY_TO:-}

      # Job 생성 시 사용할 환경 변수
      BACKEND_API_BASE: ${BACKEND_API_BASE:-http://backend:3000/api}
      BACKEND_SERVICE_API_KEY: ${BACKEND_SERVICE_API_KEY:-}
      JENKINS_CALLBACK_SECRET: ${JENKINS_CALLBACK_SECRET:-}

    ports:
      - "10218:8080" # Jenkins Web UI
      - "50000:50000" # Jenkins Agent

    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ./langgraph-scanner:/var/jenkins_home/langgraph-scanner
      - ./langgraph-scan:/var/jenkins_home/langgraph-scan
      - ./jenkins/Jenkinsfile:/var/jenkins_home/Jenkinsfile
      - jenkins_projects:/var/jenkins_home/projects
      - ./l2ve_uploads:/tmp/l2ve_uploads # 스캔 업로드 파일 접근
      - /etc/localtime:/etc/localtime:ro # 시스템 시간 동기화
      - /etc/timezone:/etc/timezone:ro # 시스템 시간 동기화, Debian/Ubuntu 계열이라면

    networks:
      - l2ve-network

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ==========================================
  # Backend (FastAPI)
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: l2ve-backend
    restart: unless-stopped

    environment:
      # Database 설정 (config.py에서 DB_* 우선 사용)
      DB_ENGINE: postgresql
      DB_HOST: ${POSTGRES_HOST:-postgres}
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_USER: ${POSTGRES_USER:-admin}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-password}
      DB_NAME: ${POSTGRES_DB:-postdb}

      # PostgreSQL 설정 (레거시 호환)
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-postdb}

      # API 설정
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-3000}
      DEBUG: ${DEBUG:-false}

      # JWT 인증
      SECRET_KEY: ${SECRET_KEY:-change-this-in-production-use-strong-random-key}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30

      # Jenkins 연동 (백엔드는 Docker 네트워크 내부 주소 사용)
      JENKINS_URL: http://jenkins:8080
      JENKINS_USER: ${JENKINS_USER:-admin}
      JENKINS_CALLBACK_SECRET: ${JENKINS_CALLBACK_SECRET:-}
      BACKEND_SERVICE_API_KEY: ${BACKEND_SERVICE_API_KEY:-}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}

    ports:
      - "${API_PORT:-3000}:3000"

    volumes:
      - jenkins_home:/jenkins_home:ro
      - ./jenkins/Jenkinsfile:/app/Jenkinsfile:ro
      - ./l2ve_uploads:/tmp/l2ve_uploads # 스캔 업로드 파일 접근

    networks:
      - l2ve-network

    depends_on:
      postgres:
        condition: service_healthy
      jenkins:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:3000/health'')" || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command: uvicorn app.main:app --host 0.0.0.0 --port 3000

  # ==========================================
  # Frontend (React + Nginx)
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
    container_name: l2ve-frontend
    restart: unless-stopped

    ports:
      - "${FRONTEND_PORT:-80}:80"

    networks:
      - l2ve-network

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test:
        ["CMD-SHELL", "wget -q -O- http://localhost:80 > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==========================================
# Volumes (데이터 영속성)
# ==========================================
volumes:
  postgres_data:
    driver: local
  jenkins_home:
    driver: local
  jenkins_projects:
    driver: local

# ==========================================
# Networks (서비스 간 통신)
# ==========================================
networks:
  l2ve-network:
    driver: bridge
