from sqlalchemy import Column, Integer, String, Text, Enum, DateTime, ForeignKey, JSON
from sqlalchemy.sql import func
from app.database import Base

class Vulnerability(Base):
    __tablename__ = "vulnerabilities"

    id = Column(Integer, primary_key=True, index=True, autoincrement=True)
    scan_id = Column(Integer, ForeignKey("scans.id", ondelete="CASCADE"), nullable=False, index=True)
    project_id = Column(Integer, ForeignKey("projects.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # 기본 정보
    severity = Column(
        Enum('critical', 'high', 'medium', 'low', 'info', name='severity_level'), 
        default='medium', 
        index=True
    )
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=True)
    cve_id = Column(String(50), nullable=True)
    cwe = Column(String(20), nullable=True, index=True)  # CWE-601, CWE-79 등
    affected_component = Column(String(255), nullable=True)
    
    # 위치 정보
    file_path = Column(String(500), nullable=True, index=True)
    line_number = Column(String(50), nullable=True)  # "100" 또는 "53-116"
    
    # 고급 분석 데이터 (JSON)
    taint_flow_analysis = Column(JSON, nullable=True)  # {source, propagation, sink}
    proof_of_concept = Column(JSON, nullable=True)     # {scenario, example}
    recommendation = Column(JSON, nullable=True)       # {how_to_fix, code_example_fix}
    
    # 상태 및 타임스탬프
    status = Column(
        Enum('open', 'in_progress', 'resolved', 'false_positive', name='vuln_status'),
        default='open',
        index=True
    )
    discovered_at = Column(DateTime(timezone=True), server_default=func.now())
    resolved_at = Column(DateTime(timezone=True), nullable=True)

