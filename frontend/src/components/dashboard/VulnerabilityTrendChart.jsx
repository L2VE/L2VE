import React, { useState } from 'react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

const VulnerabilityTrendChart = ({ timelineData, isDark }) => {
  const [activeIndex, setActiveIndex] = useState(null);

  // Transform data for Recharts
  const chartData = timelineData.map(d => ({
    date: d.date.slice(5), // MM-DD format
    fullDate: d.date,
    total: d.critical + d.high + d.medium + d.low,
    critical: d.critical,
    high: d.high,
    medium: d.medium,
    low: d.low,
  }));

  // Theme colors
  const colors = {
    primary: isDark ? '#06b6d4' : '#6366f1',
    primaryLight: isDark ? '#22d3ee' : '#818cf8',
    bg: isDark ? '#0f172a' : '#ffffff',
    cardBg: isDark ? '#1e293b' : '#f8fafc',
    border: isDark ? '#334155' : '#e2e8f0',
    text: isDark ? '#f1f5f9' : '#0f172a',
    textMuted: isDark ? '#94a3b8' : '#64748b',
    gridLine: isDark ? '#1e293b' : '#f1f5f9',
  };

  // Enhanced custom tooltip
  const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
      const data = payload[0].payload;
      return (
        <div 
          className={`rounded-xl px-4 py-3.5 backdrop-blur-xl border ${
            isDark ? 'bg-slate-900/98 border-slate-700/80' : 'bg-white/98 border-gray-200/80'
          }`}
          style={{
            boxShadow: isDark 
              ? '0 20px 40px -8px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.06), inset 0 1px 0 0 rgba(255, 255, 255, 0.08)'
              : '0 20px 40px -8px rgba(0, 0, 0, 0.18), 0 0 0 1px rgba(0, 0, 0, 0.04), inset 0 1px 0 0 rgba(255, 255, 255, 1)'
          }}
        >
          {/* Date header with better spacing */}
          <div className="flex items-center justify-between mb-3 pb-2.5 border-b" style={{ borderColor: isDark ? '#334155' : '#e5e7eb' }}>
            <span className={`text-[11px] font-semibold tracking-wide uppercase ${isDark ? 'text-slate-400' : 'text-gray-500'}`}>
              {data.fullDate}
            </span>
            <div className="flex items-baseline gap-1">
              <span className="text-2xl font-black leading-none" style={{ color: colors.primary }}>
                {data.total}
              </span>
              <span className={`text-[10px] font-medium ${isDark ? 'text-slate-500' : 'text-gray-400'}`}>
                total
              </span>
            </div>
          </div>

          {/* Severity breakdown with better design */}
          <div className="space-y-2.5 min-w-[160px]">
            {[
              { key: 'critical', label: 'Critical', color: '#ef4444', value: data.critical },
              { key: 'high', label: 'High', color: '#f97316', value: data.high },
              { key: 'medium', label: 'Medium', color: '#eab308', value: data.medium },
              { key: 'low', label: 'Low', color: '#22c55e', value: data.low }
            ].filter(s => s.value > 0).map((item) => (
              <div key={item.key} className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-2">
                  <div 
                    className="w-1.5 h-1.5 rounded-full" 
                    style={{ 
                      backgroundColor: item.color,
                      boxShadow: `0 0 6px ${item.color}60`
                    }}
                  ></div>
                  <span className="text-xs font-medium" style={{ color: item.color }}>
                    {item.label}
                  </span>
                </div>
                <span className={`text-sm font-bold tabular-nums ${isDark ? 'text-white' : 'text-gray-900'}`}>
                  {item.value}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    }
    return null;
  };

  // Custom dot with animation
  const CustomDot = (props) => {
    const { cx, cy, index } = props;
    const isActive = activeIndex === index;
    
    return (
      <g>
        {/* Outer ring on hover */}
        {isActive && (
          <>
            <circle 
              cx={cx} 
              cy={cy} 
              r={12} 
              fill={colors.primary}
              opacity={0.2}
              className="animate-ping"
            />
            <circle 
              cx={cx} 
              cy={cy} 
              r={8} 
              fill={colors.primary}
              opacity={0.3}
            />
          </>
        )}
        
        {/* Main dot */}
        <circle 
          cx={cx} 
          cy={cy} 
          r={isActive ? 5 : 4}
          fill={colors.primary}
          stroke={colors.bg}
          strokeWidth={2}
          style={{
            filter: `drop-shadow(0 ${isActive ? 4 : 2}px ${isActive ? 8 : 4}px rgba(${isDark ? '6, 182, 212' : '99, 102, 241'}, ${isActive ? 0.5 : 0.3}))`,
            transition: 'all 0.3s ease'
          }}
        />
      </g>
    );
  };

  return (
    <div 
      className={`${isDark ? 'bg-gradient-to-br from-slate-900 to-slate-900/95' : 'bg-white'} border ${isDark ? 'border-slate-800/50' : 'border-gray-200/80'} rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-lg`}
      style={{
        boxShadow: isDark 
          ? '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2), inset 0 1px 0 0 rgba(255, 255, 255, 0.05)'
          : '0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.02), inset 0 1px 0 0 rgba(255, 255, 255, 0.8)'
      }}
    >
      {/* Header - unified style with other cards */}
      <div className="px-5 pt-5 pb-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className={`text-sm font-semibold ${colors.text} flex items-center`}>
            <div className={`w-1 h-5 bg-gradient-to-b ${isDark ? 'from-blue-500 to-cyan-500' : 'from-purple-500 to-pink-500'} rounded mr-2.5`}></div>
            취약점 트렌드 분석
          </h3>
          
          {/* Legend - compact */}
          <div className="flex items-center gap-2.5 text-[11px] font-medium">
            {[
              { color: '#ef4444', label: 'Critical' },
              { color: '#f97316', label: 'High' },
              { color: '#eab308', label: 'Medium' },
              { color: '#22c55e', label: 'Low' }
            ].map((item, i) => (
              <div key={i} className="flex items-center gap-1.5">
                <div 
                  className="w-1.5 h-1.5 rounded-full" 
                  style={{ 
                    backgroundColor: item.color,
                    boxShadow: `0 0 4px ${item.color}80`
                  }}
                ></div>
                <span style={{ color: colors.textMuted }}>{item.label}</span>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Chart */}
      <div className="px-6 py-6">
        <ResponsiveContainer width="100%" height={300}>
          <AreaChart
            data={chartData}
            margin={{ top: 15, right: 5, left: -20, bottom: 5 }}
            onMouseMove={(e) => {
              if (e && e.activeTooltipIndex !== undefined) {
                setActiveIndex(e.activeTooltipIndex);
              }
            }}
            onMouseLeave={() => setActiveIndex(null)}
          >
            <defs>
              {/* Enhanced gradient for area - more subtle */}
              <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stopColor={colors.primary} stopOpacity={0.25}/>
                <stop offset="35%" stopColor={colors.primary} stopOpacity={0.12}/>
                <stop offset="75%" stopColor={colors.primary} stopOpacity={0.04}/>
                <stop offset="100%" stopColor={colors.primary} stopOpacity={0}/>
              </linearGradient>
              
              {/* Multi-color gradient for line - more dynamic */}
              <linearGradient id="lineGradient" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0%" stopColor={isDark ? '#0e7490' : '#5b21b6'} />
                <stop offset="25%" stopColor={isDark ? '#0891b2' : '#7c3aed'} />
                <stop offset="50%" stopColor={colors.primary} />
                <stop offset="75%" stopColor={colors.primaryLight} />
                <stop offset="100%" stopColor={isDark ? '#67e8f9' : '#a78bfa'} />
              </linearGradient>
              
              {/* Glow filter for line */}
              <filter id="lineGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="2.5" result="blur"/>
                <feFlood floodColor={colors.primary} floodOpacity="0.4" result="glowColor"/>
                <feComposite in="glowColor" in2="blur" operator="in" result="softGlow"/>
                <feMerge>
                  <feMergeNode in="softGlow"/>
                  <feMergeNode in="softGlow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              
              {/* Subtle shimmer effect */}
              <linearGradient id="shimmer" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="rgba(255,255,255,0)" />
                <stop offset="50%" stopColor={isDark ? "rgba(255,255,255,0.15)" : "rgba(255,255,255,0.4)"} />
                <stop offset="100%" stopColor="rgba(255,255,255,0)" />
                <animate attributeName="x1" values="-100%;200%" dur="3s" repeatCount="indefinite" />
                <animate attributeName="x2" values="0%;300%" dur="3s" repeatCount="indefinite" />
              </linearGradient>
            </defs>
            
            {/* Minimal Grid */}
            <CartesianGrid 
              strokeDasharray="2 4" 
              stroke={colors.gridLine}
              strokeOpacity={0.25}
              vertical={false}
            />
            
            {/* X Axis - cleaner */}
            <XAxis 
              dataKey="date" 
              stroke={colors.textMuted}
              tick={{ fill: colors.textMuted, fontSize: 11, fontWeight: 500 }}
              tickLine={false}
              axisLine={{ stroke: colors.border, strokeOpacity: 0.4 }}
              tickMargin={8}
            />
            
            {/* Y Axis - cleaner */}
            <YAxis 
              stroke={colors.textMuted}
              tick={{ fill: colors.textMuted, fontSize: 11, fontWeight: 500 }}
              tickLine={false}
              axisLine={{ stroke: colors.border, strokeOpacity: 0.4 }}
              width={35}
            />
            
            {/* Tooltip */}
            <Tooltip 
              content={<CustomTooltip />}
              cursor={{ 
                stroke: colors.primary, 
                strokeWidth: 1.5,
                strokeOpacity: 0.2,
                strokeDasharray: '4 4'
              }}
            />
            
            {/* Base glow layer (wider) */}
            <Area 
              type="monotone"
              dataKey="total" 
              stroke={colors.primary}
              strokeWidth={8}
              fill="none"
              strokeOpacity={0.08}
              dot={false}
              activeDot={false}
              animationDuration={1200}
              animationEasing="ease-in-out"
              isAnimationActive={true}
            />
            
            {/* Middle glow layer */}
            <Area 
              type="monotone"
              dataKey="total" 
              stroke={colors.primary}
              strokeWidth={5}
              fill="none"
              strokeOpacity={0.15}
              dot={false}
              activeDot={false}
              animationDuration={1200}
              animationEasing="ease-in-out"
              isAnimationActive={true}
            />
            
            {/* Main line with gradient and glow */}
            <Area 
              type="monotone"
              dataKey="total" 
              stroke="url(#lineGradient)"
              strokeWidth={3}
              fill="url(#colorTotal)"
              fillOpacity={1}
              dot={<CustomDot />}
              activeDot={false}
              animationDuration={1200}
              animationEasing="ease-in-out"
              filter="url(#lineGlow)"
              isAnimationActive={true}
            />
            
            {/* Top highlight line for glossy effect */}
            <Area 
              type="monotone"
              dataKey="total" 
              stroke={isDark ? 'rgba(255,255,255,0.25)' : 'rgba(255,255,255,0.5)'}
              strokeWidth={1.5}
              fill="none"
              dot={false}
              activeDot={false}
              animationDuration={1200}
              animationEasing="ease-in-out"
              isAnimationActive={true}
            />
          </AreaChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
};

export default VulnerabilityTrendChart;
